name: Build LiteXM2SDR Artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: true
        default: 'v0.1.0'
  push:
    tags:
      - 'litexm2sdr-v*'

jobs:
  build:
    name: Build all platforms
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout LiteXM2SDR.jl
        uses: actions/checkout@v6

      - name: Setup Julia 1.7
        uses: julia-actions/setup-julia@v2
        with:
          version: '1.7'

      - name: Clone Yggdrasil with LiteXM2SDR recipe
        run: |
          rm -rf "$RUNNER_TEMP/yggdrasil"
          git clone --depth 1 -b ss/litex-m2sdr-shm-utils https://github.com/zsoerenm/Yggdrasil.git "$RUNNER_TEMP/yggdrasil"

      - name: Install BinaryBuilder
        run: |
          julia -e '
            using Pkg
            Pkg.add("BinaryBuilder")
            Pkg.build()
            Pkg.instantiate()
            using BinaryBuilder
          '

      - name: Build LiteXM2SDR for all platforms
        run: |
          cd "$RUNNER_TEMP/yggdrasil/L/LiteXM2SDR"
          for target in x86_64-linux-gnu x86_64-linux-musl aarch64-linux-gnu aarch64-linux-musl; do
            echo "Building for $target..."
            julia build_tarballs.jl --verbose $target
          done

      - name: Collect artifacts and compute hashes
        id: artifacts
        run: |
          mkdir -p artifacts_metadata release_assets

          for target in x86_64-linux-gnu x86_64-linux-musl aarch64-linux-gnu aarch64-linux-musl; do
            echo "Processing $target..."

            # Find the built tarball
            TARBALL=$(find "$RUNNER_TEMP/yggdrasil/L/LiteXM2SDR/products" -name "LiteXM2SDR.v*.$target.tar.gz" | head -1)
            if [ -z "$TARBALL" ]; then
              echo "Error: No tarball found for $target"
              exit 1
            fi

            FILENAME=$(basename "$TARBALL")
            echo "Found: $FILENAME"

            # Copy to release assets
            cp "$TARBALL" "release_assets/$FILENAME"

            # Compute SHA256
            SHA256=$(sha256sum "release_assets/$FILENAME" | cut -d' ' -f1)
            echo "SHA256: $SHA256"

            # Compute git-tree-sha1 by extracting and hashing
            rm -rf "$RUNNER_TEMP/artifact_content"
            mkdir -p "$RUNNER_TEMP/artifact_content"
            tar -xzf "release_assets/$FILENAME" -C "$RUNNER_TEMP/artifact_content"
            GIT_TREE_SHA1=$(julia -e '
              using Pkg.Artifacts
              artifact_src = joinpath(ENV["RUNNER_TEMP"], "artifact_content", ".")
              hash = create_artifact() do dir
                run(`cp -r $artifact_src $dir`)
              end
              println(bytes2hex(hash.bytes))
            ')
            echo "git-tree-sha1: $GIT_TREE_SHA1"

            # Save metadata
            cat > artifacts_metadata/$target.json << EOF
          {
            "target": "$target",
            "filename": "$FILENAME",
            "sha256": "$SHA256",
            "git_tree_sha1": "$GIT_TREE_SHA1"
          }
          EOF
          done

      - name: Setup Julia for release
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract from tag (litexm2sdr-v0.1.0 -> v0.1.0)
            VERSION="${GITHUB_REF_NAME#litexm2sdr-}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=litexm2sdr-$VERSION" >> $GITHUB_OUTPUT

      - name: Install JSON3
        run: julia -e 'using Pkg; Pkg.add("JSON3")'

      - name: Generate Artifacts.toml
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Generating Artifacts.toml..."

          julia -e '
          using JSON3

          # Read all metadata files
          metadata = Dict{String, Any}()
          for f in readdir("artifacts_metadata"; join=true)
            if endswith(f, ".json")
              data = JSON3.read(read(f, String))
              target = data["target"]
              metadata[target] = data
            end
          end

          # Map target to platform info
          platform_map = Dict(
            "x86_64-linux-gnu" => (arch="x86_64", os="linux", libc="glibc"),
            "x86_64-linux-musl" => (arch="x86_64", os="linux", libc="musl"),
            "aarch64-linux-gnu" => (arch="aarch64", os="linux", libc="glibc"),
            "aarch64-linux-musl" => (arch="aarch64", os="linux", libc="musl"),
          )

          # Get version from environment
          version = ENV["VERSION"]
          repo = get(ENV, "GITHUB_REPOSITORY", "zsoerenm/LiteXM2SDR.jl")

          # Generate TOML
          toml_lines = String[]
          push!(toml_lines, "# Auto-generated Artifacts.toml for LiteXM2SDR")
          push!(toml_lines, "# Generated by GitHub Actions workflow")
          push!(toml_lines, "")

          for (target, data) in sort(collect(metadata), by=x->x[1])
            plat = platform_map[target]
            push!(toml_lines, "[[LiteXM2SDR]]")
            push!(toml_lines, "arch = \"$(plat.arch)\"")
            push!(toml_lines, "os = \"$(plat.os)\"")
            push!(toml_lines, "libc = \"$(plat.libc)\"")
            push!(toml_lines, "git-tree-sha1 = \"$(data["git_tree_sha1"])\"")
            push!(toml_lines, "lazy = true")
            push!(toml_lines, "")
            push!(toml_lines, "    [[LiteXM2SDR.download]]")
            push!(toml_lines, "    url = \"https://github.com/$repo/releases/download/litexm2sdr-$version/$(data["filename"])\"")
            push!(toml_lines, "    sha256 = \"$(data["sha256"])\"")
            push!(toml_lines, "")
          end

          write("Artifacts.toml.new", join(toml_lines, "\n"))
          println("Generated Artifacts.toml.new")
          println(read("Artifacts.toml.new", String))
          '

      - name: Finalize release assets
        run: |
          cp Artifacts.toml.new release_assets/Artifacts.toml
          ls -la release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: LiteXM2SDR ${{ steps.version.outputs.version }}
          body: |
            Pre-built LiteXM2SDR executables for use with LiteXM2SDR.jl.

            ## Usage

            The `Artifacts.toml` has been automatically committed to the repository.
            Just instantiate the project and use it:
            ```julia
            using LiteXM2SDR

            # RX streaming
            ch, warnings = read_from_litex_m2sdr(Val(1); sample_rate=40u"MHz", frequency=5u"GHz")

            # TX streaming
            stats, warnings = write_to_litex_m2sdr(signal_channel; sample_rate=40u"MHz", frequency=5u"GHz")
            ```

            ## Platforms
            - x86_64-linux-gnu
            - x86_64-linux-musl
            - aarch64-linux-gnu
            - aarch64-linux-musl
          files: release_assets/*
          draft: false
          prerelease: false

      - name: Update Artifacts.toml in repository
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Copy new Artifacts.toml
          cp Artifacts.toml.new Artifacts.toml

          # Check if there are changes
          if git diff --quiet Artifacts.toml; then
            echo "No changes to Artifacts.toml"
          else
            git add Artifacts.toml
            git commit -m "Update Artifacts.toml for LiteXM2SDR ${{ steps.version.outputs.version }}"
            git push origin HEAD:main
          fi
